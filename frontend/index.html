<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Scrabble</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <div id="app"></div>
  <script type="module">
    import * as Vue from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js'
    import { loadModule } from 'https://unpkg.com/vue3-sfc-loader/dist/vue3-sfc-loader.esm.js'
    import { LETTER_POINTS } from './letterPoints.js'

    const options = {
      moduleCache: { vue: Vue },
      async getFile(url) {
        const res = await fetch(url)
        if (!res.ok) throw Object.assign(new Error(res.statusText + ' ' + url), { res })
        return await res.text()
      },
      addStyle(textContent) {
        const style = Object.assign(document.createElement('style'), { textContent })
        const ref = document.head.getElementsByTagName('style')[0] || null
        document.head.insertBefore(style, ref)
      }
    }

    const Grid = await loadModule('./components/Grid.vue', options)
    const Home = await loadModule('./components/Home.vue', options)
    const Game = await loadModule('./components/Game.vue', options)
    const Settings = await loadModule('./components/Settings.vue', options)
    const Profile = await loadModule('./components/Profile.vue', options)
    const Login = await loadModule('./components/Login.vue', options)

    const App = {
      components: { Grid, Home, Game, Settings, Profile, Login },
      setup() {
        const view = Vue.ref('home')
        const userId = Vue.ref(localStorage.getItem('userId'))
        const ongoingGames = Vue.ref([])
        const finishedGames = Vue.ref([])
        const rack = Vue.ref([])
        const placements = Vue.ref([])
        const result = Vue.ref('')
        const gameRef = Vue.ref(null)
        const currentGame = Vue.ref(null)

        function onAuth(id) {
          userId.value = id
          localStorage.setItem('userId', id)
          view.value = 'home'
        }

        async function newGame() {
          const res = await fetch('http://localhost:8000/start', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: Number(userId.value) })
          })
          const data = await res.json()
          rack.value = data.rack
          placements.value = []
          result.value = ''
          const game = { id: data.game_id, player_id: data.player_id }
          ongoingGames.value.push(game)
          currentGame.value = game
          view.value = 'game'
        }

        function resumeGame(game) {
          currentGame.value = game
          view.value = 'game'
        }

        function finishGame() {
          if (currentGame.value) {
            const idx = ongoingGames.value.findIndex(g => g.id === currentGame.value.id)
            if (idx !== -1) ongoingGames.value.splice(idx, 1)
            finishedGames.value.push(currentGame.value)
            currentGame.value = null
          }
          view.value = 'home'
        }

        function goHome() {
          view.value = 'home'
        }

        function onDragStart(e, idx) {
          e.dataTransfer.setData('text/plain', JSON.stringify({ letter: rack.value[idx], index: idx, source: 'rack' }))
        }

        function onRackDrop(e, idx) {
          const data = JSON.parse(e.dataTransfer.getData('text/plain'))
          if (data.source === 'rack') {
            const from = data.index
            const tile = rack.value.splice(from, 1)[0]
            const insert = from < idx ? idx - 1 : idx
            rack.value.splice(insert, 0, tile)
          } else if (data.source === 'board') {
            const letter = gameRef.value.gridRef.takeBack(data.row, data.col)
            if (!letter) return
            const placementIdx = placements.value.findIndex(p => p.row === data.row && p.col === data.col)
            if (placementIdx !== -1) placements.value.splice(placementIdx, 1)
            rack.value.splice(idx, 0, letter)
          }
        }

        function placed(payload) {
          rack.value.splice(payload.index, 1)
          placements.value.push({ row: payload.row, col: payload.col, letter: payload.letter })
        }

        function removed(payload) {
          const { row, col, letter } = payload
          const i = placements.value.findIndex(p => p.row === row && p.col === col)
          if (i !== -1) placements.value.splice(i, 1)
          rack.value.push(letter)
        }

        function moved(payload) {
          const { fromRow, fromCol, toRow, toCol, letter } = payload
          const i = placements.value.findIndex(p => p.row === fromRow && p.col === fromCol)
          if (i !== -1) {
            placements.value[i] = { row: toRow, col: toCol, letter }
          }
        }

        function clearMove() {
          gameRef.value.gridRef.clearAll(placements.value)
          placements.value.forEach(p => rack.value.push(p.letter))
          placements.value = []
        }

        function shuffleRack() {
          for (let i = rack.value.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1))
            ;[rack.value[i], rack.value[j]] = [rack.value[j], rack.value[i]]
          }
        }

        async function play() {
          if (placements.value.length === 0) return
          const res = await fetch('http://localhost:8000/play', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              game_id: currentGame.value.id,
              user_id: Number(userId.value),
              placements: placements.value
            })
          })
          if (!res.ok) {
            const err = await res.json()
            result.value = err.detail || 'Coup invalide'
            return
          }
          const data = await res.json()
          result.value = `Score : ${data.score}`
          const drawRes = await fetch(
            `http://localhost:8000/draw?n=${placements.value.length}&player_id=${currentGame.value.player_id}`
          )
          const drawData = await drawRes.json()
          rack.value.push(...drawData.letters)
          placements.value = []
        }

        function passTurn() {
          clearMove()
          result.value = 'Tour pass√©'
        }

        return {
          view,
          userId,
          ongoingGames,
          finishedGames,
          newGame,
          resumeGame,
          finishGame,
          goHome,
          rack,
          onDragStart,
          placed,
          play,
          result,
          LETTER_POINTS,
          onRackDrop,
          gameRef,
          removed,
          clearMove,
          shuffleRack,
          passTurn,
          moved,
          onAuth
        }
      },
      template: `
        <Login v-if="!userId" @auth="onAuth" />
        <Home v-else-if="view==='home'"
              :ongoing-games="ongoingGames"
              :finished-games="finishedGames"
              @new-game="newGame"
              @resume="resumeGame"
              @navigate="view=$event" />
          <Game v-else-if="view==='game'"
                ref="gameRef"
                :rack="rack"
                :result="result"
                :letter-points="LETTER_POINTS"
                @home="goHome"
                @finish="finishGame"
                @placed="placed"
                @removed="removed"
                @moved="moved"
                @rack-drop="onRackDrop"
                @drag-start="onDragStart"
                @play="play"
                @clear="clearMove"
                @shuffle="shuffleRack"
                @pass="passTurn" />
          <Profile v-else-if="view==='profile'" @back="view='home'" />
          <Settings v-else-if="view==='settings'" @back="view='home'" />
        `
    }

    Vue.createApp(App).mount('#app')
  </script>
</body>

</html>
